<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: admin/institution/functionality.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: admin/institution/functionality.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* global $, wisply, server */
/**
 * @file Encapsulates the functionality for institutions
 * @author Cristian Sima
 */
/**
 * @namespace FunctionalityInstitution
 */
var FunctionalityInstitution = function() {
	'use strict';
	/**
	 * The constructor activates the listeners
	 * @memberof FunctionalityInstitution
	 * @class Manager
	 * @classdesc It encapsulets the functionality for adding an institution
	 */
	var Manager = function Manager() {
		var instance = this;
		this.nameTyper = new wisply.typerModule.Typer("institution-name", function() {
			instance.getWikiByName();
		});
		this.wikier = new wisply.wikierModule.Wikier();
		this.original = server.original;
	};
	Manager.prototype =
		/** @lends FunctionalityInstitution.Manager */
		{
			/**
			 * It activates the listeners
			 */
			init: function() {
				var instance = this;
				this.activateListeners();
				wisply.activateTooltip();
				$("#institution-name").focus();
				setTimeout(function() {
					instance.checkForChanges();
				}, 200);
			},
			/**
			 * It activates the listener for deleting a institution
			 * @fires InstitutionsManager#confirmDelete
			 */
			activateListeners: function() {
				var instance = this,
					description = $("#institution-description"),
					logo = $("#institution-logoURL");
				$("#show-wiki-source").click(this.showWikiSource);
				description.elastic();
				logo.on("change keyup paste", function() {
					instance.checkForChanges();
				});
				description.on("change keyup paste", function() {
					instance.checkForChanges();
				});
				$(".discard-description-changes").click(function() {
					$(".description-modified").hide("fast");
					instance.getWikiByName();
				});
				$("#button-get-wiki-by-address").click(function() {
					var url = $("#institution-logoURL").val();
					instance.original.wikiReceive = false;
					instance.changeLogo(url);
				});
				$("#button-institution-wikiURL").click(function() {
					instance.getWikiByPage();
				});
			},
			checkForChanges: function() {
				var wikiID = "";
				if (!this.original.wikiReceive || this.original.description !== $("#institution-description").val() || this.original.logoURL !== $("#institution-logoURL").val()) {
					wikiID = "NULL";
					this.fired_descriptionModified();
					$("#button-get-wiki-by-address").prop("disabled", false);
				} else {
					wikiID = this.original.wikiID;
					$(".description-modified").hide("fast");
					$("#button-get-wiki-by-address").prop("disabled", true);
				}
				$("#institution-wikiID").val(wikiID);
			},
			/**
			 * It shows the field for wiki source and hides the link
			 */
			showWikiSource: function(event) {
				event.preventDefault();
				$("#wiki-source-div").show("fast");
				$("#show-wiki-source").hide("fast");
				$("#institution-wikiURL").focus();
			},
			prepareForWiki: function() {
				this.original.wikiReceive = true;
				$("#institution-logo").html(wisply.getLoadingImage("medium"));
				var name = $("#institution-name"),
					description = $("#institution-description"),
					url = $("#institution-wikiURL"),
					logo = $("#institution-logoURL"),
					institutionURL = $("#institution-institution-URL"),
					submit = $("#institution-submit-button"),
					button = $("#button-institution-wikiURL");
				name.prop("disabled", true);
				description.prop("disabled", true);
				url.prop("disabled", true);
				logo.prop("disabled", true);
				institutionURL.prop("disabled", true);
				submit.prop("disabled", true);
				button.prop("disabled", true);
				description.val("");
				logo.val("");
			},
			wikiIsDone: function() {
				$("#institution-name").prop("disabled", false);
				$("#institution-description").prop("disabled", false);
				$("#institution-wikiURL").prop("disabled", false);
				$("#institution-logoURL").prop("disabled", false);
				$("#institution-institution-URL").prop("disabled", false);
				$("#institution-submit-button").prop("disabled", false);
				$("#button-institution-wikiURL").prop("disabled", false);
			},
			getWikiByName: function() {
				var instance = this,
					name = $("#institution-name"),
					newTitle = name.val();
				this.prepareForWiki();
				this.wikier.getByTitle(newTitle, function(err, page) {
					instance.wikiIsDone();
					if (err) {
						instance.wikiHasError();
					} else {
						instance.setWikiElements(page);
					}
					name.focus();
				});
			},
			getWikiByPage: function() {
				var instance = this,
					wikiURL = $("#institution-wikiURL"),
					rawPageValue = wikiURL.val(),
					goodPage = rawPageValue.substr(rawPageValue.lastIndexOf('/') + 1);
				this.prepareForWiki();
				this.wikier.getByTitle(goodPage, function(err, page) {
					instance.wikiIsDone();
					if (err) {
						instance.wikiHasError();
					} else {
						instance.setWikiElements(page);
					}
					wikiURL.focus();
				});
			},
			wikiHasError: function() {
				this.original.wikiReceive = false;
				this.setDefaultLogo();
			},
			/**
			 * It changes the logo, description, urls and wiki page ID to the ones received
			 * @param  {object} page The object which contains the elements
			 */
			setWikiElements: function(page) {
				var instance = this;
				this.changeLogo(page.thumbnail.source);
				this.changeDescription(page.extract);
				this.setWikiURL(page.fullurl);
				this.setWikiID(page.pageid);
				setTimeout(function() {
					instance.checkForChanges();
				}, 500);
			},
			/**
			 * It sets the ID of the wiki page
			 * @param {number} newID The new ID
			 */
			setWikiID: function(newID) {
				this.original.wikiID = newID;
				$("#institution-wikiID").val(newID);
			},
			/**
			 * It changes the wiki URL
			 * @param {string} newURL The new URL
			 */
			setWikiURL: function(newURL) {
				$("#institution-wikiURL").val(newURL);
			},
			setDefaultLogo: function() {
				this._setLogo("");
			},
			/**
			 * It checks if the description is empty. If so it populates it with the description.
			 * @param  {string} newDescription The new description
			 */
			changeDescription: function(newDescription) {
				var description = $("#institution-description"),
					limit = 1000,
					text = "";

				function cutDescription(text) {
					var endOfParagraph = 0;
					if (text.length > limit) {
						endOfParagraph = newDescription.lastIndexOf("\n", limit);
						text = text.substring(0, endOfParagraph);
					}
					return text;
				}
				text = cutDescription(newDescription);
				description.val(text);
				description.elastic();
				this.original.description = text;
			},
			fired_descriptionModified: function() {
				$(".description-modified").show("slow");
			},
			changeLogo: function(picture) {
				var instance = this;
				instance.checkURL(picture, function(isOk) {
					if (!isOk) {
						instance.setDefaultLogo();
					} else {
						instance._setLogo(picture);
					}
				});
			},
			_setLogo: function(url) {
				var logo = "&lt;img class='thumbnail' src='" + url + "' />";
				$("#institution-logoURL").val(url);
				this.original.logoURL = url;
				if (url === "") {
					logo = '&lt;span class="glyphicon glyphicon-education institution-logo-default">&lt;/span>';
				}
				$("#institution-logo").html(logo);
			},
			checkURL: function(URL, callback) {
				$.ajax({
					type: 'GET',
					url: URL,
					success: function() {
						callback(true);
					},
					error: function() {
						callback(false);
					}
				});
			}
		};
	return {
		Manager: Manager,
	};
};
$(document).ready(function() {
	"use strict";
	var module = new FunctionalityInstitution();
	wisply.functionalityInstitutionModule = module;
	wisply.functionalityInstitutionModule.manager = new module.Manager();
	wisply.functionalityInstitutionModule.manager.init();
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Accounts.Account.html">Account</a></li><li><a href="Accounts.Manager.html">Manager</a></li><li><a href="Administration.Admin.html">Admin</a></li><li><a href="APITableList.Manager.html">Manager</a></li><li><a href="APITableList.Table.html">Table</a></li><li><a href="Connection.Connection.html">Connection</a></li><li><a href="FunctionalityInstitution.Manager.html">Manager</a></li><li><a href="Harvest.HarvestConnection.html">HarvestConnection</a></li><li><a href="Harvest.History.html">History</a></li><li><a href="Harvest.StageManager.html">StageManager</a></li><li><a href="HarvestList.DecisionManager.html">DecisionManager</a></li><li><a href="HarvestList.GUI.html">GUI</a></li><li><a href="HarvestProcess.DecisionManager.html">DecisionManager</a></li><li><a href="HarvestProcess.Indicator.html">Indicator</a></li><li><a href="HarvestProcess.StageGUI.html">StageGUI</a></li><li><a href="HarvestProcess.WisplyCounter.html">WisplyCounter</a></li><li><a href="Institutions.GUI.html">GUI</a></li><li><a href="Institutions.Institution.html">Institution</a></li><li><a href="Institutions.Manager.html">Manager</a></li><li><a href="Log.Manager.html">Manager</a></li><li><a href="Login.Form.html">Form</a></li><li><a href="Operations.Manager.html">Manager</a></li><li><a href="Processes.Manager.html">Manager</a></li><li><a href="PublicRepository.BottomGUI.html">BottomGUI</a></li><li><a href="PublicRepository.Manager.html">Manager</a></li><li><a href="PublicRepository.SideGUI.html">SideGUI</a></li><li><a href="PublicRepository.TopGUI.html">TopGUI</a></li><li><a href="Register.Form.html">Form</a></li><li><a href="Repositories.GUI.html">GUI</a></li><li><a href="Repositories.Manager.html">Manager</a></li><li><a href="Repositories.Repository.html">Repository</a></li><li><a href="Search.Manager.html">Manager</a></li><li><a href="SearchModule.Cookies.html">Cookies</a></li><li><a href="SearchModule.Field.html">Field</a></li><li><a href="Settings.Manager.html">Manager</a></li><li><a href="TyperModule.Typer.html">Typer</a></li><li><a href="Websockets.Connection.html">Connection</a></li><li><a href="Websockets.Gui.html">Gui</a></li><li><a href="WikierModule.Wikier.html">Wikier</a></li><li><a href="Wisply.App.html">App</a></li><li><a href="Wisply.Message.html">Message</a></li><li><a href="Wisply.ShortcutManager.html">ShortcutManager</a></li></ul><h3>Events</h3><ul><li><a href="Connection.html#event:FireLogoutUser">FireLogoutUser</a></li></ul><h3>Namespaces</h3><ul><li><a href="Accounts.html">Accounts</a></li><li><a href="Administration.html">Administration</a></li><li><a href="APITableList.html">APITableList</a></li><li><a href="Connection.html">Connection</a></li><li><a href="FunctionalityInstitution.html">FunctionalityInstitution</a></li><li><a href="Harvest.html">Harvest</a></li><li><a href="HarvestList%25250DIt%252520holds%252520the%252520functionality%252520to%252520see%252520a%252520live%252520list%252520of%252520repositories.html">HarvestListIt holds the functionality to see a live list of repositories</a></li><li><a href="HarvestProcess.html">HarvestProcess</a></li><li><a href="Institutions.html">Institutions</a></li><li><a href="Log.html">Log</a></li><li><a href="Login.html">Login</a></li><li><a href="Operations.html">Operations</a></li><li><a href="Processes.html">Processes</a></li><li><a href="PublicRepository.html">PublicRepository</a></li><li><a href="Register.html">Register</a></li><li><a href="Repositories.html">Repositories</a></li><li><a href="Search.html">Search</a></li><li><a href="SearchModule.html">SearchModule</a></li><li><a href="Settings.html">Settings</a></li><li><a href="TyperModule.html">TyperModule</a></li><li><a href="Websockets.html">Websockets</a></li><li><a href="WikierModule.html">WikierModule</a></li><li><a href="Wisply.html">Wisply</a></li></ul><h3>Global</h3><ul><li><a href="global.html#analyse">analyse</a></li><li><a href="global.html#changeURL">changeURL</a></li><li><a href="global.html#disableModifyURL">disableModifyURL</a></li><li><a href="global.html#enableModifyURL">enableModifyURL</a></li><li><a href="global.html#end">end</a></li><li><a href="global.html#getCounter">getCounter</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initExistingProcess">initExistingProcess</a></li><li><a href="global.html#initNewProcess">initNewProcess</a></li><li><a href="global.html#paint">paint</a></li><li><a href="global.html#perform">perform</a></li><li><a href="global.html#setCurrentCounter">setCurrentCounter</a></li><li><a href="global.html#stop">stop</a></li><li><a href="global.html#wisply">wisply</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0-dev</a> on Fri Oct 23 2015 23:09:44 GMT+0100 (BST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
